module.exports=[70406,(e,r,t)=>{r.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},14747,(e,r,t)=>{r.exports=e.x("path",()=>require("path"))},15041,e=>{"use strict";e.s(["config",()=>u,"default",()=>h,"handler",()=>p],15041);var r=e.i(26747),t=e.i(90406),a=e.i(44898),i=e.i(62950);e.s(["default",()=>l],67354);var d=e.i(22734),n=e.i(14747);function l(e,r){let t=n.default.join(process.cwd(),"src","data","A3s.json");if("GET"===e.method){let e=JSON.parse(d.default.readFileSync(t,"utf8"));return r.status(200).json(e)}if("POST"===e.method){let i=e.body,l=JSON.parse(d.default.readFileSync(t,"utf8"));i.header.id||(i.header.id=function(e){if(!Array.isArray(e)||0===e.length)return"A3-001-A";let r=e.map(e=>{let r=(e?.header?.id||"").split("-")[1];return r?parseInt(r,10):0}).filter(e=>e>0),t=((r.length?Math.max(...r):0)+1).toString().padStart(3,"0");return`A3-${t}-A`}(l));let s=(i?.header?.id||"").split("-")[1],o=l.findIndex(e=>(e?.header?.id||"").split("-")[1]===s),f=-1!==o?l[o]:null;if(f&&f.published)return r.status(409).json({error:"A3 id already exists."});f&&f.draft?(l[o]=i,d.default.writeFileSync(t,JSON.stringify(l,null,2),"utf8")):l.push(i);try{let e=i?.header?.id;for(let r of Array.isArray(i.header?.refs)?i.header.refs:[]){let t=l.findIndex(e=>e&&e.header&&e.header.id===r);-1!==t&&(l[t].header.refBy=Array.isArray(l[t].header.refBy)?l[t].header.refBy:[],l[t].header.refBy.includes(e)||l[t].header.refBy.push(e))}}catch(e){console.error("Failed to reconcile refs on create",e)}if(d.default.writeFileSync(t,JSON.stringify(l,null,2),"utf8"),i.published)try{let e=n.default.join(process.cwd(),"src","data","A3Versions.json"),r={};if(d.default.existsSync(e)){let t=d.default.readFileSync(e,"utf8")||"{}";r=JSON.parse(t)}let s=i.header&&String(i.header.id||"").split("-")[1]||null;if(!s)throw Error("Invalid A3 header id for versioning");function a(e){if(!e)return 0;let r=e.toUpperCase().split(""),t=0;for(let e=0;e<r.length;e++)t=26*t+(r[e].charCodeAt(0)-64);return t}r[s]=r[s]||{};let o=Object.keys(r[s]||{}),f="A";if(o.length>0){let e=o.sort((e,r)=>a(e)-a(r))[o.length-1];f=function(e){if(!e)return"A";let r=e.toUpperCase().split("").map(e=>e.charCodeAt(0)-65);for(let e=r.length-1;e>=0;e--){if(r[e]+=1,r[e]<26)return r.map(e=>String.fromCharCode(65+e)).join("");if(r[e]=0,0===e)return(r=[0].concat(r)).map(e=>String.fromCharCode(65+e)).join("")}return"A"}(e)}let h=i.header.id;try{let e=String(i.header.id||"").split("-");e.length>=3&&(e[2]=f,h=e.join("-"))}catch(e){}let u={...i,header:{...i.header||{},id:h}};r[s][f]={snapshot:u,meta:{ts:Date.now(),message:"A3 Published."}},d.default.writeFileSync(e,JSON.stringify(r,null,2),"utf8");try{let e=l.findIndex(e=>e&&e.header&&String(e.header.id||"").split("-")[1]===s);if(-1!==e){let r=l[e].header.id;l[e].header.id=h;for(let t=0;t<l.length;t++)if(l[t]&&l[t].header&&t!==e){if(Array.isArray(l[t].header.refs)){let e=!1;l[t].header.refs=l[t].header.refs.map(t=>t===r?(e=!0,h):t),e&&(l[t].header.refs=Array.from(new Set(l[t].header.refs)))}if(Array.isArray(l[t].header.refBy)){let e=!1;l[t].header.refBy=l[t].header.refBy.map(t=>t===r?(e=!0,h):t),e&&(l[t].header.refBy=Array.from(new Set(l[t].header.refBy)))}}d.default.writeFileSync(t,JSON.stringify(l,null,2),"utf8"),i.header.id=h}}catch(e){console.error("Failed to update A3s ids after publishing",e)}}catch(e){console.error("Failed to write initial version snapshot or update ids",e)}return r.status(201).json(i)}if("PUT"===e.method){let a=e.body;if(!a||!a.header||!a.header.id)return r.status(400).json({error:"Invalid A3 payload"});let i=a.header.id.split("-")[1],n=JSON.parse(d.default.readFileSync(t,"utf8")),l=n.findIndex(e=>e.header.id.split("-")[1]===i);if(-1===l){n.push(a);try{let e=a.header.id;for(let r of Array.isArray(a.header.refs)?a.header.refs:[]){let t=n.findIndex(e=>e&&e.header&&e.header.id===r);-1!==t&&(n[t].header.refBy=Array.isArray(n[t].header.refBy)?n[t].header.refBy:[],n[t].header.refBy.includes(e)||n[t].header.refBy.push(e))}}catch(e){console.error("Failed to reconcile refs on upsert-new",e)}}else{let e=n[l];n[l]=a;try{let r=a.header.id,t=Array.isArray(e.header?.refs)?e.header.refs:[],i=Array.isArray(a.header?.refs)?a.header.refs:[],d=i.filter(e=>!t.includes(e)),l=t.filter(e=>!i.includes(e));for(let e of d){let t=n.findIndex(r=>r&&r.header&&r.header.id===e);-1!==t&&(n[t].header.refBy=Array.isArray(n[t].header.refBy)?n[t].header.refBy:[],n[t].header.refBy.includes(r)||n[t].header.refBy.push(r))}for(let e of l){let t=n.findIndex(r=>r&&r.header&&r.header.id===e);-1!==t&&Array.isArray(n[t].header.refBy)&&(n[t].header.refBy=n[t].header.refBy.filter(e=>e!==r))}}catch(e){console.error("Failed to reconcile refs on update",e)}}return d.default.writeFileSync(t,JSON.stringify(n,null,2),"utf8"),r.status(200).json(a)}if("DELETE"===e.method){let a=(e.body||{}).id||e.query&&e.query.id;if(!a)return r.status(400).json({error:"Missing id to delete"});let i=JSON.parse(d.default.readFileSync(t,"utf8")||"[]"),l=i.findIndex(e=>e&&e.header&&e.header.id===a);if(-1===l)return r.status(404).json({error:"A3 not found"});let s=i.splice(l,1)[0];try{for(let e=0;e<i.length;e++){let r=i[e];r&&r.header&&(Array.isArray(r.header.refs)&&(r.header.refs.length,r.header.refs=r.header.refs.filter(e=>e!==a)),Array.isArray(r.header.refBy)&&(r.header.refBy.length,r.header.refBy=r.header.refBy.filter(e=>e!==a)))}d.default.writeFileSync(t,JSON.stringify(i,null,2),"utf8")}catch(e){return console.error("Failed to write A3s.json on delete (cleanup)",e),r.status(500).json({error:"Failed to delete A3"})}try{let e=n.default.join(process.cwd(),"src","data","A3Versions.json");if(d.default.existsSync(e)){let r=d.default.readFileSync(e,"utf8")||"{}",t=JSON.parse(r),a=s&&s.header&&s.header.id?s.header.id.split("-")[1]:null;a&&t[a]&&(delete t[a],d.default.writeFileSync(e,JSON.stringify(t,null,2),"utf8"))}}catch(e){console.error("Failed to remove A3Versions entry on delete",e)}return r.status(200).json({deleted:a})}r.status(405).json({error:"Method not allowed"})}var s=e.i(67354),o=e.i(7031),f=e.i(81927);let h=(0,i.hoist)(s,"default"),u=(0,i.hoist)(s,"config"),y=new a.PagesAPIRouteModule({definition:{kind:t.RouteKind.PAGES_API,page:"/api/a3s",pathname:"/api/a3s",bundlePath:"",filename:""},userland:s,distDir:".next",relativeProjectDir:""});async function p(e,t,a){let i="/api/a3s";i=i.replace(/\/index$/,"")||"/";let d=await y.prepare(e,t,{srcPage:i});if(!d){t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve());return}let{query:n,params:l,prerenderManifest:s,routerServerContext:h}=d;try{let r=e.method||"GET",a=(0,o.getTracer)(),i=a.getActiveScopeSpan(),d=y.instrumentationOnRequestError.bind(y),u=async i=>y.render(e,t,{query:{...n,...l},params:l,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:s.preview,propagateError:!1,dev:y.isDev,page:"/api/a3s",internalRevalidate:null==h?void 0:h.revalidate,onError:(...r)=>d(e,...r)}).finally(()=>{if(!i)return;i.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let d=a.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=d.get("next.route");if(n){let e=`${r} ${n}`;i.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),i.updateName(e)}else i.updateName(`${r} ${e.url}`)});i?await u(i):await a.withPropagatedContext(e.headers,()=>a.trace(f.BaseServerSpan.handleRequest,{spanName:`${r} ${e.url}`,kind:o.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},u))}catch(e){if(y.isDev)throw e;(0,r.sendError)(t,500,"Internal Server Error")}finally{null==a.waitUntil||a.waitUntil.call(a,Promise.resolve())}}}];

//# sourceMappingURL=%5Broot-of-the-server%5D__a837b303._.js.map